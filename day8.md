# Day 8: å¤šä¼ æ„Ÿå™¨èåˆï¼šKalman Filterçš„C++å®ç°

**ã€Šç”¨å¡å°”æ›¼æ»¤æ³¢åšæŠ«è¨ï¼šå¦‚ä½•æŠŠé›·è¾¾å’Œæ‘„åƒå¤´çš„èƒ¡è¯å˜æˆé è°±å¯¼èˆªã€‹**

---

### ğŸ• **åœºæ™¯è®¾å®šï¼šä½ æ˜¯ä¸ªå¤–å–å°å“¥ï¼Œä½†GPSå’Œè½®å­éƒ½åœ¨éª—ä½ **
- **é›·è¾¾è¯´**ï¼š"ä½ ç°åœ¨åœ¨ç«æ˜Ÿï¼" ğŸ”´
- **è½®å­è¯´**ï¼š"ä¸ï¼Œä½ åœ¨å—æï¼" ğŸ›
- **çœŸç›¸**ï¼šä½ å…¶å®åœ¨å°åŒºé—¨å£ï¼Œä½†ä¸¤ä¸ªä¼ æ„Ÿå™¨éƒ½åœ¨æŠ½é£
- **ä»»åŠ¡**ï¼šç”¨å¡å°”æ›¼æ»¤æ³¢æŠŠç«æ˜Ÿå’Œå—æçš„é¬¼è¯èåˆæˆé è°±çš„ä½ç½®ä¼°è®¡

---

### ğŸ”§ **å¡å°”æ›¼æ»¤æ³¢å››æ­¥æ‹†è§£ï¼ˆé™„C++ä»£ç ï¼‰**

#### **ç¬¬ä¸€æ­¥ï¼šå»ºç«‹ä¿¡ä»°ï¼ˆçŠ¶æ€æ¨¡å‹ï¼‰**
å‡è®¾ä½ éª‘ç”µåŠ¨è½¦ï¼ŒçŠ¶æ€åŒ…æ‹¬ä½ç½®å’Œé€Ÿåº¦ï¼š
```cpp
class KalmanFilter {
public:
    // çŠ¶æ€å‘é‡ [x, y, vx, vy] äºŒç»´ä½ç½®+é€Ÿåº¦
    Eigen::VectorXd x; 
    // åæ–¹å·®çŸ©é˜µ (ä¸ç¡®å®šæ€§çŸ©é˜µ)
    Eigen::MatrixXd P; 
  
    // çŠ¶æ€è½¬ç§»çŸ©é˜µ (å‡è®¾åŒ€é€Ÿè¿åŠ¨)
    Eigen::MatrixXd F = Eigen::MatrixXd::Identity(4,4); 
    F(0,2) = dt;  // x = x + vx*dt
    F(1,3) = dt;  // y = y + vy*dt
  
    // è¿‡ç¨‹å™ªå£° (æ¯”å¦‚çªç„¶åŠ é€Ÿ)
    Eigen::MatrixXd Q = Eigen::MatrixXd::Zero(4,4);
    Q(2,2) = 0.1; // é€Ÿåº¦å¯èƒ½æœ‰0.1çš„æ–¹å·®
    Q(3,3) = 0.1;
};
```
**å“²å­¦æ„ä¹‰**ï¼š
- `F`çŸ©é˜µï¼šç›¸ä¿¡ä¸–ç•Œæ˜¯çº¿æ€§çš„ï¼ˆè™½ç„¶ç°å®å¾ˆéª¨æ„Ÿï¼‰
- `Q`çŸ©é˜µï¼šæ‰¿è®¤è‡ªå·±ä¸æ‡‚ç©ºæ°”åŠ¨åŠ›å­¦

---

#### **ç¬¬äºŒæ­¥ï¼šé¢„æµ‹æœªæ¥ï¼ˆå…ˆè’™ä¸ºæ•¬ï¼‰**
```cpp
void predict(double dt) {
    // æ›´æ–°çŠ¶æ€è½¬ç§»çŸ©é˜µçš„æ—¶é—´é¡¹
    F(0,2) = dt;
    F(1,3) = dt;
  
    // é¢„æµ‹çŠ¶æ€ (é—­çœ¼çŒœ)
    x = F * x;
    // é¢„æµ‹åæ–¹å·® (ä¸ç¡®å®šæ€§å¢åŠ )
    P = F * P * F.transpose() + Q;
}
```
**ç°å®æ¯”å–»**ï¼š
- è’™çœ¼éª‘ç”µåŠ¨è½¦ï¼Œé ä¸Šæ¬¡è®°å¿†ä¼°è®¡å½“å‰ä½ç½®
- æ—¶é—´è¶Šé•¿(`dt`è¶Šå¤§)ï¼Œä½ç½®è¶Šä¸ç¡®å®šï¼ˆåæ–¹å·®`P`è†¨èƒ€ï¼‰

---

#### **ç¬¬ä¸‰æ­¥ï¼šè†å¬ä¼ æ„Ÿå™¨ï¼ˆä½†è¦æ‰“æŠ˜ï¼‰**
```cpp
void update(const Eigen::VectorXd& z, const Eigen::MatrixXd& H, 
           const Eigen::MatrixXd& R) {
    // è®¡ç®—å¡å°”æ›¼å¢ç›Š (è¯¥ä¿¡ä¼ æ„Ÿå™¨å¤šå°‘?)
    Eigen::MatrixXd K = P * H.transpose() * 
                      (H * P * H.transpose() + R).inverse();
  
    // ç”¨è§‚æµ‹å€¼ä¿®æ­£é¢„æµ‹                    
    x = x + K * (z - H * x);
    // æ›´æ–°ä¸ç¡®å®šæ€§ (ç°åœ¨æ›´è‡ªä¿¡äº†)
    P = (Eigen::MatrixXd::Identity(4,4) - K*H) * P;
}
```
**å‚æ•°è§£è¯»**ï¼š
- `H`çŸ©é˜µï¼šä¼ æ„Ÿå™¨åªèƒ½çœ‹åˆ°éƒ¨åˆ†çŠ¶æ€ï¼ˆå¦‚GPSåªçœ‹ä½ç½®ï¼‰
- `R`çŸ©é˜µï¼šä¼ æ„Ÿå™¨çš„å¯ä¿¡åº¦ï¼ˆè¶Šå¤§çš„å€¼=è¶Šä¸é è°±ï¼‰
- **ç„å­¦æ“ä½œ**ï¼š`K`å°±åƒè°ƒéŸ³å°ï¼Œåœ¨é¢„æµ‹å’Œè§‚æµ‹ä¹‹é—´æ»‘åŠ¨è°ƒèŠ‚

---

#### **ç¬¬å››æ­¥ï¼šå¤šä¼ æ„Ÿå™¨äº¤å“ä¹ï¼ˆèåˆé›·è¾¾+æ‘„åƒå¤´ï¼‰**
```cpp
// é›·è¾¾æ•°æ® (æåæ ‡è½¬ç¬›å¡å°”)
Eigen::VectorXd radar_z = polar_to_cartesian(radar_r, radar_theta);
Eigen::MatrixXd H_radar = ...;  // é›·è¾¾çš„è§‚æµ‹çŸ©é˜µ
Eigen::MatrixXd R_radar = ...;  // é›·è¾¾å™ªå£°å¤§(æ¯”å¦‚0.5)

kf.update(radar_z, H_radar, R_radar);

// æ‘„åƒå¤´æ•°æ® (ç›´æ¥ç»™å‡ºx,y)
Eigen::VectorXd camera_z = get_camera_position();
Eigen::MatrixXd H_camera = ...; // æ‘„åƒå¤´åªçœ‹ä½ç½®
Eigen::MatrixXd R_camera = ...; // æ‘„åƒå¤´å™ªå£°å°(æ¯”å¦‚0.1)

kf.update(camera_z, H_camera, R_camera);
```
**èåˆç­–ç•¥**ï¼š
- é›·è¾¾è™½ä¸å‡†ä½†èƒ½æµ‹é€Ÿ â†’ é€‚åˆä¿®æ­£é€Ÿåº¦
- æ‘„åƒå¤´ç²¾åº¦é«˜ä½†å¯èƒ½ä¸¢å¸§ â†’ ä¸»æ”»ä½ç½®ä¿®æ­£
- **æ•ˆæœ**ï¼šæ¯”å•ä¼ æ„Ÿå™¨å‡†2å€ï¼Œæ¯”ç›´æ¥å¹³å‡å‡†5å€

---

### ğŸš€ **C++å®ç°å½©è›‹ï¼ˆå«é©¬é‡Œå¥¥èµ›è½¦ç§˜ç±ï¼‰**
#### **ä»£ç æ¨¡æ¿ï¼šäºŒç»´ç›®æ ‡è·Ÿè¸ª**
```cpp
#include <Eigen/Dense>

class KalmanFilter {
public:
    void init(const Eigen::Vector4d& init_state) {
        x = init_state;
        P.setIdentity(); // åˆå§‹ä¸ç¡®å®šåº¦ï¼šæå¤§
    }

    void predict(double dt) {
        // ...åŒå‰æ–‡é¢„æµ‹æ­¥éª¤
    }

    void update(const Eigen::VectorXd& z, 
                const Eigen::MatrixXd& H,
                const Eigen::MatrixXd& R) {
        // ...åŒå‰æ–‡æ›´æ–°æ­¥éª¤
    }

private:
    Eigen::VectorXd x; // çŠ¶æ€
    Eigen::MatrixXd P; // åæ–¹å·®
    // ...å…¶ä»–çŸ©é˜µ
};
```

#### **ä½¿ç”¨ç¤ºä¾‹ï¼šè·Ÿè¸ªç‹‚é­”**
```cpp
KalmanFilter kf;
kf.init({0, 0, 5, 5});  // åˆå§‹åœ¨åŸç‚¹ï¼Œé€Ÿåº¦5m/s

while (true) {
    // é¢„æµ‹æ­¥éª¤ (dt=0.1ç§’)
    kf.predict(0.1);
  
    // å‡è®¾é›·è¾¾å’Œæ‘„åƒå¤´äº¤æ›¿æ›´æ–°
    if (has_radar_data()) {
        auto [z_radar, H_radar, R_radar] = get_radar_obs();
        kf.update(z_radar, H_radar, R_radar);
    }
  
    if (has_camera_data()) {
        auto [z_cam, H_cam, R_cam] = get_camera_obs();
        kf.update(z_cam, H_cam, R_cam);
    }
  
    // è·å–æœ€ä¼˜ä¼°è®¡
    Eigen::Vector4d state = kf.getState(); 
    cout << "å½“å‰ä½ç½®: (" << state[0] << ", " << state[1] << ")";
}
```

---

### ğŸ§¨ **å¡å°”æ›¼æ»¤æ³¢ç¿»è½¦æŒ‡å—**
**ç¿»è½¦ç°åœº1ï¼šçŸ©é˜µç»´åº¦å¯¹ä¸ä¸Š**
- **ç—‡çŠ¶**ï¼šEigenåº“æŠ¥é”™ä¿¡æ¯æ¯”ã€Šç™¾å¹´å­¤ç‹¬ã€‹è¿˜é•¿
- **è¯æ–¹**ï¼š
  ```cpp
  #define EIGEN_NO_DEBUG  // å…³é—­Eigençš„é˜²å‘†æ£€æŸ¥ (å‹‡å£«ä¸“ç”¨)
  ```

**ç¿»è½¦ç°åœº2ï¼šåæ–¹å·®çŸ©é˜µå˜éæ­£å®š**
- **ç—‡çŠ¶**ï¼šçªç„¶ç®—å‡ºå…‰é€Ÿç§»åŠ¨çš„ä½ç½®
- **æŠ¢æ•‘**ï¼š
  ```cpp
  P = 0.5*(P + P.transpose()); // å¼ºåˆ¶å¯¹ç§°
  ```

**ç¿»è½¦ç°åœº3ï¼šä¼ æ„Ÿå™¨å‘ç¥ç»**
- **ç—‡çŠ¶**ï¼šæ‘„åƒå¤´çªç„¶è¯´ç›®æ ‡åœ¨å†¥ç‹æ˜Ÿ
- **å¯¹ç­–**ï¼š
  ```cpp
  if (z.norm() > 1000) {  // è¶…å‡ºåˆç†èŒƒå›´
      // å‡è£…æ²¡çœ‹è§è¿™ä¸ªæ•°æ®
      return;
  }
  ```

---

### ğŸŒŸ **é«˜æ‰‹æŠ€å·§ï¼šä»é’é“œåˆ°ç‹è€…**
1. **è‡ªé€‚åº”QçŸ©é˜µ**ï¼š
   ```cpp
   Q(2,2) = abs(x[2]) * 0.1; // é€Ÿåº¦è¶Šå¿«ï¼Œè¿‡ç¨‹å™ªå£°è¶Šå¤§
   ```
   - è®©æ»¤æ³¢å™¨è‡ªå·±æ„ŸçŸ¥æ˜¯å¦åœ¨æ¼‚ç§»

2. **å¼‚æ­¥ä¼ æ„Ÿå™¨å¤„ç†**ï¼š
   - ç”¨æœ€æ–°æ•°æ®çš„æ—¶é—´å·®åšé¢„æµ‹ï¼Œä¸å¼ºåˆ¶ç­‰æ‰€æœ‰ä¼ æ„Ÿå™¨

3. **æ‰©å±•å¡å°”æ›¼æ»¤æ³¢(EKF)**ï¼š
   - å½“è¿åŠ¨æ¨¡å‹éçº¿æ€§æ—¶ï¼ˆæ¯”å¦‚è½¬å¼¯ï¼‰ï¼ŒæŠŠ`F`æ¢æˆé›…å¯æ¯”çŸ©é˜µ
   - **ä»£ä»·**ï¼šå¤´å‘åŠ é€Ÿè„±è½

---

### ğŸ“œ **å¡å°”æ›¼åè¯«ï¼ˆç¨‹åºå‘˜ç‰ˆï¼‰**
1. æ±çš„åˆå§‹åæ–¹å·®ä¸å¯å¤ªå°ï¼Œå¦åˆ™æ”¶æ•›æ…¢å¦‚èœ—ç‰›
2. ä¸å¯å…¨ä¿¡é¢„æµ‹ï¼Œäº¦ä¸å¯å…¨ä¿¡ä¼ æ„Ÿå™¨
3. å¤„ç†æ¿€å…‰é›·è¾¾æ—¶ï¼Œè®°å¾—åšåæ ‡å˜æ¢
4. è‹¥ç”¨IMUæ•°æ®ï¼Œå…ˆå’ŒGPSæ—¶é—´å¯¹é½
5. è°ƒè¯•æ—¶ä¼˜å…ˆå¯è§†åŒ–åæ–¹å·®æ¤­åœ†
6. é‡åˆ°é¬¼ç•œè½¨è¿¹ï¼Œå…ˆæŸ¥ä¼ æ„Ÿå™¨æ—¶é—´æˆ³
7. æ°¸è¿œå‡è®¾ç¬¬ä¸€ä¸ªè§‚æµ‹æ•°æ®æ˜¯é”™çš„
8. åœ¨è½¦è½½è®¾å¤‡ä¸Šï¼ŒçŸ©é˜µè¿ç®—è¦ç”¨å®šç‚¹æ•°ä¼˜åŒ–
9. ä¸è¦å°è¯•åœ¨æ»¤æ³¢å™¨ä¸­èåˆå¥³æœ‹å‹çš„æƒ…ç»ªæ•°æ®
10. å½“ä¸€åˆ‡æ­£å¸¸æ—¶ï¼Œè®°ä½â€”â€”è¿™åªæ˜¯å·§åˆ

---

**è¯¾åä½œä¸š**ï¼š
1. å°è¯•ç”¨å¡å°”æ›¼æ»¤æ³¢é¢„æµ‹æ˜å¤©Aè‚¡èµ°åŠ¿ï¼ˆå¹¶åšå¥½åˆ åº“å‡†å¤‡ï¼‰
2. åœ¨ä»£ç ä¸­åŠ å…¥"æ€¥åˆ¹æ£€æµ‹"ï¼Œå½“åŠ é€Ÿåº¦çªå˜æ—¶è°ƒå¤§Q
3. å½“äº§å“ç»ç†è¦æ±‚å…¼å®¹é‡å­ä¼ æ„Ÿå™¨æ—¶ï¼Œé€’ä¸Šè¾èŒä¿¡

ï¼ˆé™„åŠ é¢˜ï¼šç”¨å¡å°”æ›¼æ»¤æ³¢èåˆå®¶é‡Œçš„æ™ºèƒ½ä½“é‡ç§¤å’Œå¥èº«ç¯æ•°æ®ï¼Œè®¡ç®—å‡ºçœŸå®ä½“è„‚ç‡ï¼‰

---

**ç»ˆæé¢†æ‚Ÿ**ï¼š
> "å¡å°”æ›¼æ»¤æ³¢ä¸æ˜¯ç®—æ³•ï¼Œæ˜¯ä¸€ç§åœ¨æ··æ²Œä¸–ç•Œä¸­ä¿æŒæ¸…é†’çš„å“²å­¦ã€‚"
> â€”â€” æŸä¸ªåœ¨åœè½¦åœºè°ƒè¯•ä¸‰å¤©æ»¤æ³¢å™¨çš„å·¥ç¨‹å¸ˆ